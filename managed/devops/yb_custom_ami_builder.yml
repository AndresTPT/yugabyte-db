# Todo: Make cloud_type dynamic when we come to GCP VM image phase.
- name: Deploy 3rd-parties
  shell:
    cmd: >
      ~/code/devops/bin/py_wrapper
      ansible-playbook
      ~/code/devops/docker/images/thirdparty-deps/dependencies.yml
  environment:
    yb_devops_home: "~/code/devops"
    YB_MANAGED_DEVOPS_USE_PYTHON3: 1
  become: yes
  become_user: "{{ ansible_user_id }}"

- name: "preprovision"
  import_playbook: preprovision.yml
  vars:
    yb_ansible_host: "default"

- name: "Use custom ssh port"
  import_playbook: use_custom_ssh_port.yml
  vars:
    yb_ansible_host: "default"

- name: "YB Server Provision"
  import_playbook: yb-server-provision.yml
  vars:
    node_exporter_port: "9300"
    server_type: "cluster-server"
    yb_prebuilt_ami_host: "default"

- name: "Configure cluster server"
  import_playbook: configure-cluster-server.yml
  vars:
    yb_prebuilt_ami_host: "default"
    ansible_user: "{{ user_name }}"
    ansible_port: "{{ custom_ssh_port }}"

- name: "Cleanup Yugabyte auth"
  hosts: "default"
  vars:
    ansible_user: "{{ user_name }}"
    ansible_port: "{{ custom_ssh_port }}"
  gather_facts: no
  tasks:
    - name: "Clean up SSH keys"
      file:
        path: "/home/{{ user_name }}/.ssh/authorized_keys"
        state: absent
      tags: yb-prebuilt-ami
